name: Function Tests (Docker)

on:
  workflow_call:
    inputs:
      function_name:
        description: "Имя функции для проверки (без расширения)"
        required: true
        type: string
    secrets:
      OPENROUTER_API_KEY:
        required: true

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      # Чекаутим репозиторий с функцией (репо А)
      - name: Checkout function repo
        uses: actions/checkout@v4

      # Чекаутим репозиторий с Dockerfile (репо B)
      - name: Checkout docker/tests repo
        uses: actions/checkout@v4
        with:
          repository: Smaipl/Tests-Function-Api-Calling-OpenAi
          path: tests-repo

      # Собираем Docker-образ из репо B
      - name: Build Docker image
        run: |
          cd tests-repo
          docker build -t function-tests .

      # Проверяем виртуальное окружение
      - name: Test virtual environment
        run: |
          docker run --rm function-tests /app/.venv/bin/python -c "import yaml; print('yaml available')"
          docker run --rm function-tests /app/.venv/bin/python -c "import openai; print('openai available')"

      # Запускаем контейнер и пробрасываем переменные окружения
      - name: Run tests in Docker
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
        run: |
          docker run --rm \
            -e OPENROUTER_API_KEY="$OPENROUTER_API_KEY" \
            -e GITHUB_STEP_SUMMARY="$GITHUB_STEP_SUMMARY" \
            -v "$GITHUB_WORKSPACE:/function_code" \
            -v "$GITHUB_WORKSPACE:/results" \
            function-tests \
            /app/.venv/bin/python test_runner.py \
              --function "/function_code/${{ inputs.function_name }}.py" \
              --schema "/function_code/${{ inputs.function_name }}.json" \
              --tests "/function_code/${{ inputs.function_name }}.yaml" \
              --output "/results/test_results.json"


      # Сохраняем артефакт для скачивания
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_results.json
