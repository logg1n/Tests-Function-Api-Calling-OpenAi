name: Function Tests (Docker)

on:
  workflow_call:
    inputs:
      function_name:
        description: "Имя функции для проверки (без расширения)"
        required: true
        type: string
    secrets:
      OPENROUTER_API_KEY:
        required: true
      ADDITIONAL_SECRETS:
        required: false
        description: "Дополнительные секреты в формате JSON"

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout function repo (A)
        uses: actions/checkout@v4

      - name: Checkout docker/tests repo (B)
        uses: actions/checkout@v4
        with:
          repository: Smaipl/Tests-Function-Api-Calling-OpenAi
          path: tests-repo

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Copy requirements from repo A to repo B (optional)
        run: |
          if [ -f requirements.txt ]; then
            cp requirements.txt tests-repo/requirements.txt
          else
            echo "requirements.txt not found, skipping"
          fi

      - name: Build Docker image
        run: |
          cd tests-repo
          docker build -t function-tests .

      - name: Run tests in Docker
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ADDITIONAL_SECRETS: ${{ secrets.ADDITIONAL_SECRETS }}
        run: |
          ENV_FILE="$(mktemp)"
          if [ -n "$ADDITIONAL_SECRETS" ]; then
            echo "$ADDITIONAL_SECRETS" | jq -r '
              to_entries | .[] | "\(.key)=\(.value)"
            ' > "$ENV_FILE"
          else
            : > "$ENV_FILE"
          fi

          docker run --rm \
            -e OPENROUTER_API_KEY="$OPENROUTER_API_KEY" \
            --env-file "$ENV_FILE" \
            -v "$GITHUB_WORKSPACE:/function_code" \
            function-tests \
            /app/.venv/bin/python test_runner.py \
              --function "/function_code/${{ inputs.function_name }}.py" \
              --schema "/function_code/${{ inputs.function_name }}.json" \
              --tests "/function_code/${{ inputs.function_name }}.yaml" \
          > results.log

          rm -f "$ENV_FILE"

      - name: Write summary
        run: |
          echo "### Результаты тестов" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat results.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: results.log
